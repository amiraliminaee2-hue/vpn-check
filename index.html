<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>بررسی اتصال</title>

<style>
body {
    font-family: Tahoma, sans-serif;
    direction: rtl;
    text-align: center;
    background-color: #f5f5f5;
    margin-top: 80px;
}
.box {
    background: #fff;
    padding: 25px;
    max-width: 420px;
    margin: auto;
    border-radius: 8px;
    border: 1px solid #ddd;
}
button {
    margin-top: 15px;
    padding: 10px 20px;
    cursor: pointer;
}
</style>
</head>
<body>

<div id="content" class="box">
    در حال بررسی اتصال...
</div>

<script>
const MAIN_URL = "https://example.com";
const TIMEOUT_MS = 5000; // حداکثر زمان انتظار

function showBlocked() {
    document.getElementById("content").innerHTML = `
        ⚠️ <strong>اتصال شما مشکوک شناسایی شد</strong>
        <br><br>
        لطفاً فیلترشکن را خاموش کرده و دوباره تلاش کنید.
        <br><br>
        <button onclick="location.reload()">بررسی مجدد</button>
    `;
}

async function checkVPN() {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), TIMEOUT_MS);

    try {
        const res = await fetch("https://ipwho.is/", {
            signal: controller.signal
        });
        const data = await res.json();

        clearTimeout(timeout);

        const isVPN =
            data.success === false ||
            data.proxy === true ||
            data.hosting === true ||
            data.type === "hosting";

        if (isVPN) {
            showBlocked();
        } else {
            window.location.replace(MAIN_URL);
        }

    } catch (err) {
        // هر خطا = مشکوک
        showBlocked();
    }
}

// جلوگیری از دور زدن با رفرش
if (localStorage.getItem("vpn_decision")) {
    if (localStorage.getItem("vpn_decision") === "blocked") {
        showBlocked();
    } else {
        window.location.replace(MAIN_URL);
    }
} else {
    checkVPN().then(() => {
        // ذخیره تصمیم
        if (document.getElementById("content").innerText.includes("مشکوک")) {
            localStorage.setItem("vpn_decision", "blocked");
        } else {
            localStorage.setItem("vpn_decision", "ok");
        }
    });
}
</script>

</body>
</html>
